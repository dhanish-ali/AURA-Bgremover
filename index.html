<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aura BG Remover</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for retro aesthetic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- MediaPipe libraries for ML-based background removal -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js" crossorigin="anonymous"></script>

    <style>
        /* Custom styles for the retro theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .font-retro {
            font-family: 'Press Start 2P', cursive;
        }

        .text-glow {
            text-shadow: 0 0 8px rgba(255, 105, 180, 0.6), 0 0 10px rgba(138, 43, 226, 0.6);
        }

        .btn-retro {
            background-color: #16213e;
            border: 2px solid #0f3460;
            color: #e94560;
            box-shadow: 4px 4px 0px #0f3460;
            transition: all 0.2s ease-in-out;
        }

        .btn-retro:hover:not(:disabled) {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0px #0f3460;
        }
        
        .btn-retro:active:not(:disabled) {
            transform: translate(4px, 4px);
            box-shadow: 0px 0px 0px #0f3460;
        }

        .btn-retro:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Hide the video element, we only need it for input */
        #video-input {
            display: none;
        }
        
        /* Loading spinner */
        .loader {
            border: 8px solid #f3f3f320;
            border-top: 8px solid #e94560;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Custom select styling */
        .select-retro {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #16213e;
            border: 2px solid #0f3460;
            color: #e94560;
            padding: 0.5rem 2.5rem 0.5rem 1rem;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23e94560' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4">

    <!-- Header -->
    <header class="text-center mb-6">
        <h1 class="font-retro text-3xl md:text-5xl text-glow">Aura BG Remover</h1>
        <p class="text-gray-400 mt-2">Client-side background removal with a retro twist</p>
    </header>

    <!-- Controls -->
    <div class="flex flex-wrap justify-center items-center gap-4 mb-6">
        <button id="upload-btn" class="btn-retro font-bold py-2 px-6 rounded-lg">Upload Image</button>
        <button id="webcam-btn" class="btn-retro font-bold py-2 px-6 rounded-lg">Use Webcam</button>
        <div class="flex items-center gap-2">
            <select id="format-select" class="select-retro rounded-lg font-bold">
                <option value="image/png">PNG</option>
                <option value="image/jpeg">JPEG</option>
            </select>
            <button id="download-btn" class="btn-retro font-bold py-2 px-6 rounded-lg" disabled>Download</button>
        </div>
        <input type="file" id="file-input" accept="image/*" class="hidden">
    </div>
    
    <!-- Main Content Area -->
    <div id="main-content" class="relative w-full max-w-3xl aspect-video bg-black/30 rounded-xl shadow-2xl overflow-hidden flex items-center justify-center">
        <!-- The video element for camera input -->
        <video id="video-input"></video>
        
        <!-- The canvas where the output will be drawn -->
        <canvas id="output-canvas" class="w-full h-full"></canvas>
        
        <!-- Loading Spinner -->
        <div id="loader" class="absolute hidden loader"></div>
        
        <!-- Placeholder Text -->
        <div id="placeholder" class="absolute text-center text-gray-400 p-4">
            <p class="font-retro text-lg">Upload an image or start your webcam</p>
        </div>

    </div>

    <script type="module">
        // --- DOM Element Selection ---
        const videoElement = document.getElementById('video-input');
        const canvasElement = document.getElementById('output-canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const uploadBtn = document.getElementById('upload-btn');
        const webcamBtn = document.getElementById('webcam-btn');
        const fileInput = document.getElementById('file-input');
        const loader = document.getElementById('loader');
        const placeholder = document.getElementById('placeholder');
        const mainContent = document.getElementById('main-content');
        const downloadBtn = document.getElementById('download-btn');
        const formatSelect = document.getElementById('format-select');

        let camera = null; // To hold the camera instance
        let isOutputReady = false; // To track if there is content to download

        // --- Core Logic: MediaPipe Selfie Segmentation ---
        
        function onResults(results) {
            loader.classList.add('hidden');
            
            canvasElement.width = results.image.width;
            canvasElement.height = results.image.height;

            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.segmentationMask, 0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.globalCompositeOperation = 'source-in';
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.restore();
            
            // Enable download button now that there's an output
            isOutputReady = true;
            downloadBtn.disabled = false;
        }

        const selfieSegmentation = new SelfieSegmentation({locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${file}`;
        }});
        
        selfieSegmentation.setOptions({ modelSelection: 1 });
        selfieSegmentation.onResults(onResults);


        // --- UI Interaction Logic ---

        uploadBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (event) => {
            if (camera) {
                camera.stop();
                camera = null;
                videoElement.srcObject = null;
            }
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');
            downloadBtn.disabled = true;

            const file = event.target.files[0];
            if (file) {
                const image = new Image();
                image.src = URL.createObjectURL(file);
                image.onload = () => {
                    selfieSegmentation.send({image: image});
                    URL.revokeObjectURL(image.src);
                };
            }
        });

        webcamBtn.addEventListener('click', () => {
            placeholder.classList.add('hidden');
            loader.classList.remove('hidden');
            downloadBtn.disabled = true;

            camera = new Camera(videoElement, {
                onFrame: async () => {
                    await selfieSegmentation.send({image: videoElement});
                },
                width: 1280,
                height: 720
            });
            camera.start();
        });

        // --- Download Logic ---
        downloadBtn.addEventListener('click', () => {
            if (!isOutputReady) return;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            // Match dimensions of the visible canvas
            tempCanvas.width = canvasElement.width;
            tempCanvas.height = canvasElement.height;
            
            // If JPEG, fill background with the page color, otherwise it's transparent for PNG
            const selectedFormat = formatSelect.value;
            if (selectedFormat === 'image/jpeg') {
                tempCtx.fillStyle = '#1a1a2e';
                tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            }

            // Draw the main content (person with removed BG)
            tempCtx.drawImage(canvasElement, 0, 0);

            // Trigger download
            const link = document.createElement('a');
            const fileExtension = selectedFormat.split('/')[1];
            link.download = `aura-output.${fileExtension}`;
            link.href = tempCanvas.toDataURL(selectedFormat, 1.0); // 1.0 is for max quality for JPEG
            link.click();
        });

    </script>
</body>
</html>

